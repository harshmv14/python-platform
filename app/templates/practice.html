{% extends "base.html" %}

{% block content %}
<div class="card">
    {% if is_challenge %}
    <div style="font-size: 1.5em; font-weight: bold; color: #ffc107; margin-bottom: 1rem;">
        üèÜ Challenge Mode! Timer: <span id="timer">00:00</span>
    </div>
    {% endif %}

    <h1>{{ question.title }}</h1>
    <p>{{ question.description|safe }}</p>

    {% if hints_enabled and question.hints %}
    <div style="margin-top: 2rem;">
        <button id="hint-button" class="btn btn-warning" onclick="toggleHint()">Show Hint</button>
        <div id="hint-content" style="display: none; margin-top: 1rem; padding: 1rem; background-color: var(--slate-800); border-radius: 8px;">
            <strong>Hint:</strong> {{ question.hints }}
        </div>
    </div>
    {% endif %}
</div>

{% if question.has_file_manager %}
    <style>
        .ide-container { display: flex; gap: 1rem; flex-wrap: wrap; }
        .file-browser { width: 100%; md:width: 25%; min-width: 200px; }
        .editor-container { width: 100%; md:width: 75%; }
        .file-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .file-list li { padding: 8px; cursor: pointer; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; word-break: break-all; }
        .file-list li:hover { background-color: var(--slate-800); }
        .file-list li.active { background-color: var(--indigo-600); color: white; }
        .file-actions a { margin-left: 8px; font-size: 0.8em; }
        .tabs { display: flex; border-bottom: 1px solid var(--slate-800); }
        .tab-button { padding: 10px 15px; cursor: pointer; background: none; border: none; color: var(--gray-400); font-family: 'Poppins', sans-serif; font-size: 1em; }
        .tab-button.active { color: var(--white); border-bottom: 2px solid var(--indigo-600); }
        .tab-content { display: none; padding-top: 1rem; }
        .tab-content.active { display: block; }
    </style>
    <div class="ide-container">
        <div class="file-browser card">
            <h4>File Manager</h4>
            <button id="new-file-btn" class="btn" style="width:100%; margin-bottom: 1rem;">+ New File</button>
            <ul id="file-list" class="file-list"></ul>
        </div>
        <div class="editor-container">
            <div class="card">
                <h4 id="active-filename"></h4>
                <div id="code-editor" style="height: 400px; width: 100%;">{{ initial_code or '' }}</div><br>
                <button id="run-button" class="btn">‚ñ∂ Run Code</button>
                {% if is_challenge %}
<button id="submit-btn" class="btn btn-success" style="margin-left: 10px;">
    üèÜ Submit Challenge
</button>
{% endif %}
            </div>
            <div class="card">
                <div class="tabs">
                    <button class="tab-button active" onclick="openTab(event, 'console')">Console</button>
                    <button class="tab-button" onclick="openTab(event, 'variables')">Variable Inspector</button>
                </div>
                <div id="console" class="tab-content active">
                    <h3>Output:</h3>
                    <pre id="output-area">Click "Run Code" to see the output.</pre>
                </div>
                <div id="variables" class="tab-content">
                    <h3>Variables:</h3>
                    <div id="variable-area"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const editor = ace.edit("code-editor");
        editor.setTheme("ace/theme/chrome");
        editor.session.setMode("ace/mode/python");
        editor.setFontSize(14);
        const fileListEl = document.getElementById('file-list');
        const activeFilenameEl = document.getElementById('active-filename');
        const runButton = document.getElementById('run-button');
        const newFileBtn = document.getElementById('new-file-btn');
        const outputArea = document.getElementById('output-area');
        let activeFile = null;
        const Q_ID = {{ question.id }};
        const isChallenge = {{ is_challenge|tojson }};
        let startTime = null;
        if (isChallenge) {
            startTime = Date.now();
            const timerDisplay = document.getElementById('timer');
            setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                const minutes = String(Math.floor(elapsedSeconds / 60)).padStart(2, '0');
                const seconds = String(elapsedSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
            }, 1000);
        }
        async function fetchFiles() { const response = await fetch(`/api/files/list?q_id=${Q_ID}`); const files = await response.json(); renderFileList(files); if (files.length > 0 && !activeFile) { const pyFile = files.find(f => f.endsWith('.py')) || files[0]; openFile(pyFile); } else if (files.length === 0) { editor.setValue('', -1); activeFile = null; activeFilenameEl.textContent = "No file open. Create a new file."; } }
        function renderFileList(files) { fileListEl.innerHTML = ''; files.forEach(filename => { const li = document.createElement('li'); const nameSpan = document.createElement('span'); nameSpan.textContent = `üìÑ ${filename}`; li.appendChild(nameSpan); li.dataset.filename = filename; if (filename === activeFile) { li.classList.add('active'); } const actions = document.createElement('span'); actions.className = 'file-actions'; const downloadLink = document.createElement('a'); downloadLink.href = `/download-file?q_id=${Q_ID}&filename=${filename}`; downloadLink.textContent = 'üì•'; actions.appendChild(downloadLink); li.appendChild(actions); li.addEventListener('click', (e) => { if (e.target.tagName !== 'A') openFile(filename); }); fileListEl.appendChild(li); }); }
        async function openFile(filename) { const response = await fetch(`/api/files/content?q_id=${Q_ID}&filename=${filename}`); const data = await response.json(); editor.setValue(data.content, 1); activeFile = filename; activeFilenameEl.textContent = `Editing: ${filename}`; const allFiles = await (await fetch(`/api/files/list?q_id=${Q_ID}`)).json(); renderFileList(allFiles); }
        async function saveActiveFile() { if (!activeFile) return; await fetch(`/api/files/save`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({q_id: Q_ID, filename: activeFile, content: editor.getValue()}) }); }
        newFileBtn.addEventListener('click', async () => { const filename = prompt("Enter new filename (e.g., helpers.py):"); if (filename && filename.trim() !== "") { await fetch(`/api/files/create`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({q_id: Q_ID, filename: filename}) }); await fetchFiles(); openFile(filename); } });
        runButton.addEventListener('click', async () => { if (!activeFile) { alert("Please create and open a file to run."); return; } await saveActiveFile(); outputArea.textContent = 'Executing...'; runButton.disabled = true; const payload = { q_id: Q_ID, code: editor.getValue(), filename: activeFile }; if (isChallenge) { payload.start_time = startTime; } const response = await fetch(`/api/run_code`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); const result = await response.json(); let fullOutput = result.output; if (result.error) { fullOutput += `\n--- ERRORS ---\n${result.error}`; } outputArea.textContent = fullOutput; renderVariables(result.variables); runButton.disabled = false; await fetchFiles(); });
        let saveTimeout; editor.on('change', () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveActiveFile, 2000); });
        fetchFiles();
    </script>

{% else %}
    <div class="card">
        <h3>Your Code:</h3>
        <div id="code-editor" style="height: 400px; width: 100%;">{{ initial_code or question.starter_code or '' }}</div><br>
        <button id="run-button" class="btn">‚ñ∂ Run Code</button>
    </div>
    <div class="card">
        <style>
            .tabs { display: flex; border-bottom: 1px solid var(--slate-800); }
            .tab-button { padding: 10px 15px; cursor: pointer; background: none; border: none; color: var(--gray-400); font-family: 'Poppins', sans-serif; font-size: 1em; }
            .tab-button.active { color: var(--white); border-bottom: 2px solid var(--indigo-600); }
            .tab-content { display: none; padding-top: 1rem; }
            .tab-content.active { display: block; }
        </style>
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'console')">Console</button>
            <button class="tab-button" onclick="openTab(event, 'variables')">Variable Inspector</button>
        </div>
        <div id="console" class="tab-content active">
            <h3>Output:</h3>
            <pre id="output-area">Click "Run Code" to see the output.</pre>
        </div>
        <div id="variables" class="tab-content">
            <h3>Variables:</h3>
            <div id="variable-area"></div>
        </div>
    </div>
    <script>
        const editor = ace.edit("code-editor");
        editor.setTheme("ace/theme/chrome");
        editor.session.setMode("ace/mode/python");
        editor.setFontSize(14);
        const isChallenge = {{ is_challenge|tojson }};
        let startTime = null;
        if (isChallenge) {
            startTime = Date.now();
            const timerDisplay = document.getElementById('timer');
            setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                const minutes = String(Math.floor(elapsedSeconds / 60)).padStart(2, '0');
                const seconds = String(elapsedSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
            }, 1000);
        }
        document.getElementById('run-button').addEventListener('click', async () => {
            const outputArea = document.getElementById('output-area');
            outputArea.textContent = 'Executing...';
            const payload = { q_id: {{ question.id }}, code: editor.getValue() };
            if (isChallenge) { payload.start_time = startTime; }
            const response = await fetch('/api/run_code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            let fullOutput = result.output;
            if (result.error) { fullOutput += `\n--- ERRORS ---\n${result.error}`; }
            outputArea.textContent = fullOutput;
            renderVariables(result.variables);
        });
    </script>
{% endif %}

<script>
  // Add this inside the main <script> tag for both views

if (isChallenge) {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.addEventListener('click', async () => {
        outputArea.textContent = 'Submitting for validation...';
        submitBtn.disabled = true;
        runButton.disabled = true;

        const payload = {
            q_id: Q_ID,
            code: editor.getValue(),
            start_time: startTime
        };
        // For IDE view, ensure the active file is saved and used in payload
        if (typeof activeFile !== 'undefined' && activeFile) {
            await saveActiveFile();
            payload.filename = activeFile;
        }

        const response = await fetch('/api/submit_challenge', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        outputArea.textContent = result.output + '\n\n--- STATUS ---\n' + result.message;

        if (result.is_correct) {
            // Submission was correct, keep button disabled
        } else {
            // Submission was incorrect, re-enable buttons
            submitBtn.disabled = false;
            runButton.disabled = false;
        }
    });
}
    // --- COMMON FUNCTIONS (Used by both Simple and IDE views) ---
    function toggleHint() {
        const hintContent = document.getElementById('hint-content');
        const hintButton = document.getElementById('hint-button');
        if (hintContent.style.display === 'none') {
            hintContent.style.display = 'block';
            hintButton.textContent = 'Hide Hint';
        } else {
            hintContent.style.display = 'none';
            hintButton.textContent = 'Show Hint';
        }
    }
    
    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        const parentCard = evt.currentTarget.closest('.card');
        tabcontent = parentCard.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = parentCard.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        parentCard.querySelector('#' + tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function renderVariables(variables) {
        const varArea = document.getElementById('variable-area');
        if (!variables || variables.length === 0) {
            varArea.innerHTML = '<p>No variables to display.</p>';
            return;
        }
        let tableHTML = '<table class="leaderboard-table"><thead><tr><th>Name</th><th>Type</th><th>Value</th></tr></thead><tbody>';
        variables.forEach(v => {
            const safeValue = v.value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            tableHTML += `<tr><td>${v.name}</td><td>${v.type}</td><td><pre style="margin:0; white-space: pre-wrap; word-break: break-all;">${safeValue}</pre></td></tr>`;
        });
        tableHTML += '</tbody></table>';
        varArea.innerHTML = tableHTML;
    }
</script>
{% endblock %}
